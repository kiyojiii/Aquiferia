<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE-edge">
  <meta name="viewport" content="width=device-width, intial-scale=1.0">
  <title> Soil Metric Records </title>
  <!-- Bootstrap and Icons -->
  <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
  <script src="https://kit.fontawesome.com/334c45a40c.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
    integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
    integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
    crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>

  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="js/jquery-3.3.1.slim.min.js"></script>
  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery-3.3.1.min.js"></script>

  <!-- Data From Firebase to DataTables -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.css" />
  <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-firestore.js"></script>

  <!-- Include jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Include DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
  <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="css/bootstrap.min.css">

  <!----css3---->
  <link rel="stylesheet" href="css/custom.css">

  <!-- SLIDER REVOLUTION 4.x CSS SETTINGS -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">

  <!--google material icon-->
  <link href="https://fonts.googleapis.com/css2?family=Material+Icons" rel="stylesheet">
</head>

<body>

  <div class="wrapper">
    <div class="body-overlay"></div>

    <!-- Sidebar  -->
    <nav id="sidebar">
      <div class="sidebar-header">
        <h3><img src="../dist/himg/logo.png" height="100px" class="img-fluid" /><span>Aquiferia</span></h3>
      </div>
      <ul class="list-unstyled components">
        <li>
          <a href="dashboard.html" class="dashboard"><i class="material-icons">dashboard</i><span>Dashboard</span></a>
        </li>

        <div class="small-screen navbar-display">

          <li class="d-lg-none d-md-block d-xl-none d-sm-block">
            <a href="#"><i class="material-icons">person</i><span>user</span></a>
          </li>

          <li class="d-lg-none d-md-block d-xl-none d-sm-block">
            <a href="#"><i class="material-icons">settings</i><span>setting</span></a>
          </li>
        </div>

        <li class="dropdown active">
          <a href="#pageSubmenu6" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
            <i class="material-icons">grid_on</i><span>tables</span></a>
          <ul class="collapse list-unstyled menu" id="pageSubmenu6">
            <li class="active">
              <a href="crudpage.html"><i class="material-icons">folder_open</i>Soil Metric Records</a>
            </li>
            <!-- <li>
                                <a href="#">Page 2</a>
                            </li>
                            <li>
                                <a href="#">Page 3</a>
                            </li> -->
          </ul>
        </li>

        <li class="dropdown">
          <a href="#pageSubmenu3" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
            <i class="material-icons">equalizer</i>


            <span>Visualization</span></a>
          <ul class="collapse list-unstyled menu" id="pageSubmenu3">
            <li>
              <a href="chart.html"><i class="material-icons">equalizer</i>Bar & Line Graph</a>
            </li>
            <!-- <li>
                                <a href="#">Page 2</a>
                            </li>
                            <li>
                                <a href="#">Page 3</a>
                            </li> -->
          </ul>
        </li>

        <li class="">
          <a href="#" id="logout"><i class="material-icons">logout</i><span>Logout</span></a>
        </li>


      </ul>


    </nav>



    <!-- Page Content  -->
    <div id="content">

      <div class="top-navbar">
        <nav class="navbar navbar-expand-lg">
          <div class="container-fluid">

            <button type="button" id="sidebarCollapse" class="d-xl-block d-lg-block d-md-mone d-none">
              <span class="material-icons">arrow_back_ios</span>
            </button>

            <a class="navbar-brand" href="crudpage.html"> Soil Metric Records </a>

            <button class="d-inline-block d-lg-none ml-auto more-button" type="button" data-toggle="collapse"
              data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
              aria-label="Toggle navigation">
              <span class="material-icons">more_vert</span>
            </button>

            <div class="collapse navbar-collapse d-lg-block d-xl-block d-sm-none d-md-none d-none"
              id="navbarSupportedContent">
              <ul class="nav navbar-nav ml-auto">
                <li class="nav-item active">
                  <a class="nav-link" href="#">
                    <span class="material-icons">person</span>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#">
                    <span class="material-icons">settings</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </div>


      <div class="main-content">
        <div class="row mb-3">
          <div class="col-auto">
            <button id="add-btn" type="button" class="btn btn-success add-btn" data-bs-toggle="modal"
              data-bs-target="#add-modal">
              <i class="fa-solid fa-square-plus"></i> Add Data
            </button>
          </div>
        </div>
        <table id="myTable" class="display">
          <thead>
            <tr>
              <th>No. </th>
              <th>Plant Name</th>
              <th>Moisture </th>
              <th>Temperature </th>
              <th>Humidity </th>
              <th>Date Time</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
      </div>


      <!-- Add Modal -->
      <div id="add-modal" class="modal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add Data</h5>
              <button type="button" id="close" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="form-row">
                <form>
                  <div class="form-group col-md-12">
                    <label for="PlantName" class="form-label" required>Plant Name:</label>
                    <input type="text" class="form-control" id="PlantName" required style="width: 120%;">
                  </div>
                  <div class="form-group col-md-7">
                    <label for="Moisture" class="form-label" required>Moisture Level:</label>
                    <div class="input-group">
                      <input type="number" class="form-control" id="Moisture" required>
                      <span class="input-group-text">%</span>
                    </div>
                    <label for="Temperature" class="form-label" required>Temp Level:</label>
                    <div class="input-group">
                      <input type="number" class="form-control" id="Temperature" required>
                      <span class="input-group-text">°C</span>
                    </div>
                    <label for="Humidity" class="form-label" required>Humidity Level:</label>
                    <div class="input-group">
                      <input type="number" class="form-control" id="Humidity" required>
                      <span class="input-group-text">%</span>
                    </div>
                  </div>
                  <div class="form-group col-md-10">
                    <label for="DateTime" class="form-label">Date and Time:</label>
                    <input type="datetime-local" class="form-control" id="DateTime" required>
                  </div>
                </form>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="add-button">Add</button>
            </div>
          </div>
        </div>
      </div>
      <!-- Edit Modal -->
      <div id="edit-modal" class="modal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit Data</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                id="edit-close"></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="form-group col-md-7">
                  <label for="PlantName" class="form-label" required>Plant Name:</label>
                  <input type="text" class="form-control" id="plantNameInput" required style="width: 120%;">
                </div>
                <div class="form-group col-md-4">
                  <label for="Moisture" class="form-label" required>Moisture Level:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="moistureLevelInput" required>
                    <span class="input-group-text">%</span>
                  </div>
                  <label for="Temperature" class="form-label" required>Temp Level:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="temperatureLevelInput" required>
                    <span class="input-group-text">°C</span>
                  </div>
                  <label for="Humidity" class="form-label" required>Humidity Level:</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="humidityLevelInput" required>
                    <span class="input-group-text">%</span>
                  </div>
                </div>
                <div class="form-group col-md-6">
                  <label for="DateTime" class="form-label">Edit Date and Time:</label>
                  <input type="datetime-local" class="form-control" id="DateTimeInput">
                </div>
                <div class="form-group col-md-6">
                  <label for="DateTime" class="form-label">Current Date and Time</label>
                  <input type="text" class="form-control" id="DateTimeValue" readonly>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                id="edit-close-button">Close</button>
              <button type="button" class="btn btn-primary" id="update-button">Save changes</button>
            </div>
          </div>
        </div>
      </div>




      <footer class="footer">
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-6">
              <nav class="d-flex">
                <ul class="m-0 p-0">
                  <li>
                    <a href="#">
                      Home
                    </a>
                  </li>
                  <li>
                    <a href="#">
                      Company
                    </a>
                  </li>
                  <li>
                    <a href="#">
                      Portfolio
                    </a>
                  </li>
                  <li>
                    <a href="#">
                      Blog
                    </a>
                  </li>
                </ul>
              </nav>

            </div>
            <div class="col-md-6">
              <p class="copyright d-flex justify-content-end"> &copy 2023 Design by
                <a href="#"> &nbsp CJV &nbsp </a> Aquiferia
              </p>
            </div>
          </div>
        </div>
      </footer>

    </div>



  </div>
  </div>


  <!-- firebase js -->
  <script type="module">

    // Import the functions you need from the SDKs you need
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-analytics.js';
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      signInWithPopup,
      onAuthStateChanged,
    }
      from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';
    import {
      getFirestore,
      collection,
      addDoc,
      connectFirestoreEmulator,
      query,
      getDocs,
      getDoc,
      updateDoc,
      setDoc,
      doc,
      onSnapshot,
      deleteDoc,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js';

    // Import the functions you need from the SDKs you need
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyDOIDgSedybvSSPD2TejDmtdD0SZNoPS7U",
      authDomain: "aquiferia-f9786.firebaseapp.com",
      projectId: "aquiferia-f9786",
      storageBucket: "aquiferia-f9786.appspot.com",
      messagingSenderId: "236511073621",
      appId: "1:236511073621:web:2059e210c6ab5ac2e18bdc",
      measurementId: "G-52S8RPWSMV"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const provider = new GoogleAuthProvider();
    // const provider2 = new FacebookAuthProvider();
    // const auth = getAuth();
    console.log(app)

    //Firestore
    const db = getFirestore(app);

    //DataTables
    firebase.initializeApp(firebaseConfig);
    const db2 = firebase.firestore();  // Function for Database Firestore 

    function updateSuccess() {
      Swal.fire({
        title: "Success",
        text: "Record updated successfully",
        icon: "success",
      });
    }

    function updateError(errorMessage) {
      Swal.fire({
        title: "Error",
        text: `There was an error updating the record: ${errorMessage}`,
        icon: "error",
      });
    }

    // Get the data from Firestore and add it to the DataTable
    db2.collection("MoistureRecords")
      .orderBy("DateTime", "desc")
      .onSnapshot(
        (querySnapshot) => {
          let counter = 1; // initialize counter variable
          const table = $('#myTable').DataTable(); // cache DataTable instance
          table.clear(); // clear existing data in the table
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const dateTime = data["DateTime"];
            const date = new Date(dateTime.toDate()).toLocaleDateString();
            const time = new Date(dateTime.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Edit Button
            const editButton = `<button type="button" class="btn btn-warning btn-sm edit" data-id="${doc.id}-edit" data-plantname="${data['Plant Name']}" data-moisturelevel="${data['Moisture Level'].replace('%', '')}" data-temperaturelevel="${data['Temperature Level'].replace('°C', '')}" data-humiditylevel="${data['Humidity Level'].replace('%', '')}" data-datetime="${dateTime.toDate()}">Edit</button>`;
            $(document).on('click', '.edit', function () {
              if ($(this).data('id') === `${doc.id}-edit`) {
                console.log(`Editing document with ID: ${doc.id}`); // add this line
                const docId = $(this).data('id').replace('-edit', '');
                const plantName = $(this).data('plantname');
                const moistureLevel = $(this).data('moisturelevel');
                const temperatureLevel = $(this).data('temperaturelevel');
                const humidityLevel = $(this).data('humiditylevel');
                const dateTime = $(this).data('datetime');
                // Pass data to edit form and display it
                $('#plantNameInput').val(plantName);
                $('#moistureLevelInput').val(moistureLevel);
                $('#temperatureLevelInput').val(temperatureLevel);
                $('#humidityLevelInput').val(humidityLevel);
                const date = new Date(dateTime).toLocaleDateString();
                const time = new Date(dateTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                $('#DateTimeValue').val(`${date} ${time}`);
                $('#edit-modal').modal('show');
                $('#update-button').data('id', docId);
              }
            });

            // Add event listener for edit button
            $(document).on('click', '#update-button', function () {
              const docId = $(this).data('id');
              const plantName = $('#plantNameInput').val();
              const moistureLevel = $('#moistureLevelInput').val() + '%';
              const temperatureLevel = $('#temperatureLevelInput').val() + '°C';
              const humidityLevel = $('#humidityLevelInput').val() + '%';
              const dateTime = new Date($('#DateTimeValue').val());
              const newData = {
                'Plant Name': plantName,
                'Moisture Level': moistureLevel,
                'Temperature Level': temperatureLevel,
                'Humidity Level': humidityLevel,
                'DateTime': firebase.firestore.Timestamp.fromDate(dateTime) // Fix: can't update time yet will fix soon
              };
              console.log('Updating docId:', docId); // Check if Document ID matches with docID
              db2.collection("MoistureRecords").doc(docId).update(newData) // update only the specific document
              .then(() => {
                console.log("update success");
                $('#edit-modal').modal('hide');
                updateSuccess();
                // exit the forEach loop by throwing an exception
                throw new Error("Update successful - exit forEach");
              })
              .catch((error) => {
                if (error.message === "Update successful - exit forEach") {
                  return; // exit the forEach loop
                }
                console.error("Error updating record: ", error);
                console.log("Error message: ", error.message);
                updateError(error.message);
              });
            });

            // Delete
            const deleteButton = `<button type="button" class="btn btn-danger btn-sm delete" data-id="${doc.id}-delete">Delete</button>`;
            // Add event listener for delete button
            $(document).on('click', '.delete', function () {
              if ($(this).data('id') === `${doc.id}-delete`) {
                Swal.fire({
                  title: "Are you sure?",
                  text: `Do you really want to delete the record for ${data["Plant Name"]}?`,
                  icon: 'warning',
                  showCancelButton: true,
                  confirmButtonColor: '#d33',
                  cancelButtonColor: '#3085d6',
                  confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                  if (result.isConfirmed) {
                    db2.collection("MoistureRecords").doc(doc.id).delete()
                      .then(() => {
                        console.log("Successful Delete")
                        Swal.fire({
                          title: "Deleted!",
                          text: `The record for ${data["Plant Name"]} has been deleted`,
                          icon: "success",
                        });
                        table.row($(this).closest('tr')).remove().draw(); // remove row from DataTable
                      })
                      .catch((error) => {
                        console.error("Error removing record: ", error);
                        Swal.fire({
                          title: "Error",
                          text: "There was an error removing the record.",
                          icon: "error",
                        });
                      });
                  }
                });
              }
            });
            
            // Displays the Data to the Tables
            table.row.add([
              counter++, // increment counter variable and include as first column
              data["Plant Name"],
              data["Moisture Level"],
              data["Temperature Level"],
              data["Humidity Level"],
              `${date} ${time}`,
              `${editButton} ${deleteButton}`
            ]);

          });
          table.draw(); // refresh the table with new data
        },
        (error) => {
          console.log(`Error getting documents: ${error}`);
        }
      );



    // <----- ADD MODAL -----> 

    // Get the add modal element from the DOM
    const addModal = document.getElementById("add-modal");

    // Get the input fields and buttons from the add modal
    const addPlantnameInput = addModal.querySelector("#PlantName");
    const addMoistureInput = addModal.querySelector("#Moisture");
    const addTemperatureInput = addModal.querySelector("#Temperature");
    const addHumidityInput = addModal.querySelector("#Humidity");
    const addDatetimeInput = addModal.querySelector("#DateTime");
    const addButton = addModal.querySelector("#add-button");
    const cancelButton = addModal.querySelector("#cancel-button");

    // Add event listener to the add button
    addButton.addEventListener("click", () => {
      const PlantName = addPlantnameInput.value.trim();
      const Moisture = addMoistureInput.value.trim();
      const Temperature = addTemperatureInput.value.trim();
      const Humidity = addHumidityInput.value.trim();
      const DateTime = new Date(addDatetimeInput.value.trim());

      // Check if any of the input fields are blank
      if (!PlantName || !Moisture || !Temperature || !Humidity || !DateTime) {
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Please Fill Out All The Fields"
        });
        return;
      }

      // Add the data to Firestore
      addDoc(collection(db, "MoistureRecords"), {
        "Plant Name": PlantName,
        "Moisture Level": Moisture + "%",
        "Temperature Level": Temperature + "°C",
        "Humidity Level": Humidity + "%",
        "DateTime": DateTime
      })
        .then((docRef) => {
          console.log("Document written with ID: ", docRef.id);
        })
        .catch((error) => {
          console.error("Error adding document: ", error);
        });

      // Reset the input fields
      addPlantnameInput.value = "";
      addMoistureInput.value = "";
      addTemperatureInput.value = "";
      addHumidityInput.value = "";
      addDatetimeInput.value = "";

      function hideAddModal() {
        const addModal = new bootstrap.Modal(document.querySelector("add-modal"));
        const modalBackdrop = document.querySelector('.modal-backdrop');

        // Hide the modal
        addModal.hide();

        // Remove the backdrop
        modalBackdrop.parentNode.removeChild(modalBackdrop);
      }

      // Show a success message
      Swal.fire({
        icon: "success",
        title: "Data Added Successfully",
        text: "You can either close this modal or add more data"
      });
    });

    // Add event listener to the add modal to reset the input fields
    addModal.addEventListener("hidden.bs.modal", () => {
      addPlantnameInput.value = "";
      addMoistureInput.value = "";
      addTemperatureInput.value = "";
      addHumidityInput.value = "";
      addDatetimeInput.value = "";
    });

    //----- Logout code start	  
    document.getElementById("logout").addEventListener("click", function () {
      signOut(auth).then(() => {
        // Sign-out successful.
        console.log('Sign-out successful.');
        (Swal.fire({
          icon: 'success',
          title: 'Logged Out Successfully',
        }));
        setTimeout(function () {
          window.location.href = "index.html"; //will redirect to your blog page (an ex: blog.html)
        }, 2000);
      }).catch((error) => {
        // An error happened.
        console.log('An error happened.');
        (Swal.fire({
          icon: 'error',
          title: 'An Error Has Occured',
          text: '' + error,
        }));;
      });
    });

  </script>

  <!-- Data Table Show Entries -->
  <script>
    $('#myTable').dataTable({
      "lengthMenu": [[6, 15, 50, -1], [6, 15, 50, "All"]]
    });
  </script>


  <!-- Optional JavaScript -->
  <script type="text/javascript">
    $(document).ready(function () {
      $('#sidebarCollapse').on('click', function () {
        $('#sidebar').toggleClass('active');
        $('#content').toggleClass('active');
      });

      $('.more-button,.body-overlay').on('click', function () {
        $('#sidebar,.body-overlay').toggleClass('show-nav');
      });

    });

  </script>

</body>

</html>